name: Deployment Connection Test

on:
  push:
    branches:
      - main # Change this to the branch you push code to

jobs:
  test_connection:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        # This step pulls your repository code onto the runner VM (not needed for this specific test, but good practice)

      - name: SSH Connection and Script Execution Test
        uses: appleboy/ssh-action@v1.0.0
        with:
          # --- Configuration from GitHub Secrets ---
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          
          # --- Script to Run on the VPS ---
          # This is a multiline command block that runs *after* a successful SSH connection
          script: |
            # 1. Announce successful connection
            echo "--- âœ… SUCCESS: SSH Connection Established ---"
            
            # 2. Define the path for the test folder
            TEST_DIR="/root/github_actions_test"
            
            # 3. Create a folder (using -p flag to avoid error if it already exists)
            mkdir -p $TEST_DIR
            echo "--- Created directory: $TEST_DIR ---"
            
            # 4. Write a file inside the new folder with a timestamp
            echo "Deployment Test Run at $(date)" > $TEST_DIR/test_log.txt
            echo "--- Wrote test_log.txt inside $TEST_DIR ---"
            
            # 5. List the contents of the directory to verify
            echo "--- Verification on VPS ---"
            ls -al $TEST_DIR